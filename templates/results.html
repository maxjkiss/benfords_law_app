<!DOCTYPE html>
<html>

<head>
    <title>Results</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>
    <h1>Results</h1>
    <ul>
        {% for result in results %}
        <li>
            <a href="#" data-chart='{{ result.data | tojson | safe }}' data-benford='{{ result.benford }}'
                onclick="drawChart(this, '{{ result.id }}')">{{ result.file.filename }} - {{ result.column_name }}</a>
        </li>
        {% endfor %}
    </ul>

    <div id="chart"></div>

    <script>
        function drawChart(element, id) {
            d3.select("#chart svg").remove(); // Clear the previous chart
            var data = JSON.parse(JSON.parse(element.getAttribute('data-chart')));
            var width = 960; // Use the same value as in index.html
            var height = 500; // Use the same value as in index.html
            var radius = Math.min(width, height) / 2; // This determines the radius of the pie chart
            var color = d3.scaleOrdinal(d3.schemeCategory10);
            var svg = d3.select('#chart')
                .append('svg')
                .attr('preserveAspectRatio', 'xMidYMid meet')
                .attr('viewBox', '0 0 ' + width + ' ' + height)
                .append('g')
                .attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');

            // Add a title to the pie chart
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", 20)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .style("text-decoration", "underline")
                .text("Pie Chart Title");

            var arc = d3.arc()
                .innerRadius(0)
                .outerRadius(radius);
            var pie = d3.pie()
                .value(function (d) { return d.frequency; }) // specify how to extract the numbers
                .sort(null);
            var path = svg.selectAll('path')
                .data(pie(data));

            // Remove old paths
            path.exit().remove();

            // Add new paths
            path.enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', function (d, i) { return color(d.data.digit); });

            var labelArc = d3.arc()
                .outerRadius(radius - 40)
                .innerRadius(radius - 40);
            svg.selectAll('text')
                .data(pie(data))
                .enter()
                .append('text')
                .attr('transform', function (d) { return 'translate(' + labelArc.centroid(d) + ')'; })
                .attr('dy', '.35em')
                .style('fill', 'white')
                .style('font-size', '20px')
                .text(function (d) { return d.data.digit; });

            // Add text whether it passes Benford's law
            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", height - 20)
                .attr("text-anchor", "middle")
                .style("font-size", "16px")
                .text("Passes Benford's law: " + element.getAttribute('data-benford'));

            var tooltip = d3.select("body").append("div").attr("class", "toolTip");
            path.on("mousemove", function (d) {
                tooltip
                    .style("left", d3.event.pageX + 10 + "px")
                    .style("top", d3.event.pageY - 25 + "px")
                    .style("display", "inline-block")
                    .html((d.data.digit) + "<br>" + (d.data.frequency * 100).toFixed(2) + "%");
            })
                .on("mouseout", function (d) { tooltip.style("display", "none"); });
        }
    </script>
</body>

</html>